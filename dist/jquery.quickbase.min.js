!function(e){e.QuickBase=function(t,n){function i(){f.payload=e("<qdbapi>"),f.payload.append(e("<ticket>").text(f.ticket)),f.payload.append(e("<apptoken>").text(f.settings.apptoken))}function a(t){return e("<div/>").append(t.clone()).html()}function o(e,t,n,i){this.action=e,this.errcode=t,this.errtext=n,this.errdetail=i,alert(n+"\n\n"+i)}function d(e){console.log(e),console.log(e.message)}function r(t){var n,i;if("array"==typeof t)for(n in t)i="<"+n+">",f.payload.append(e(i).text(t[n]))}function p(t,r,p,u,c){u="main"===u?f.base_url+"main":f.base_url+f.settings.dbid,i(),window.loading.show(),e.ajax({type:"POST",beforeSend:function(e){e.setRequestHeader("QUICKBASE-ACTION",r)},url:u,data:a(p),async:f.settings.async,dataType:"xml",contentType:"text/xml",success:function(a){var p,u,f=parseInt(e(a).find("errcode").text(),10);try{if(f>0)throw p=e(a).find("errtext").text(),u=e(a).find("errdetail").text(),new o(r,f,p,u);return i(),"function"==typeof n&&t===!0&&(a=n(a)),"function"==typeof c?c(a):a}catch(s){d(s)}},error:function(e,t,n){console.log(e),console.log(t),console.log(n)}}),f.settings.async=!0}var u={async:!0,username:"",password:"",dbid:"",apptoken:void 0,realm:"www.quickbase.com"},f=this;return f.settings={},f.payload=e("</qbdapi>"),f.init=function(n){return f.settings=e.extend({},u,t),f.base_url="https://"+f.settings.realm+"/db/","undefined"!=typeof f.token||"undefined"!=typeof f.settings.apptoken?"function"==typeof n?n():this:void f.authenticate(void 0,void 0,void 0,function(t){return f.ticket=e(t).find("ticket").text(),"function"==typeof n?n():this})},f.record=function(e,t){var n=isNaN(e)?'name="'+e+'"':'fid="'+e+'"';return"<field "+n+">"+t+"</field>"},f.authenticate=function(t,n,a,o){var d=e("<qdbapi>");return"undefined"==typeof t&&(t=f.settings.username),"undefined"==typeof n&&(n=f.settings.password),"undefined"==typeof a&&(a=""),""===t||""===n?(i(),o(),!1):(d.append(e("<username>").text(t)),d.append(e("<password>").text(n)),d.append(e("<hours>").text(a)),void p(!1,"API_AUTHENTICATE",d,"main",o))},f.build_schema=function(t){var n={};p(!1,"API_GetSchema",f.payload,"db",function(i){function a(i){var d,r,p,u;return f.settings.dbid=e(o[i]).text(),i+1>o.length?"function"==typeof t?t(n):n:void f.get_schema(function(t){function f(t){if(t=t||0,t+1>d.length)return e.extend(n[y],p),!1;var i=e(d[t]),a=i.find("label").text(),o=a.toLowerCase().replace(/\W/g,"_"),r=i.attr("id"),u=i.attr("field_type");p.fields[o]={id:r,label:a,field_type:u},f(t+1)}function c(t){if(t=t||0,t+1>r.length)return e.extend(n[y],u),!1;var i=e(r[t]);query_id=i.attr("id"),query_name_raw=i.find("qyname").text(),query_name=query_name_raw.toLowerCase().replace(/\W/g,"_"),u.queries[query_name]={id:query_id,name:query_name_raw},c(t+1)}var s=e(o[i]),l=s.text(),y=s.attr("name").substring("_dbid_".length);n[y]={dbid:l},d=e(t).find("field"),p={fields:{}},d.length&&f(),r=e(t).find("query"),u={queries:{}},r.length&&c(),a(i+1)})}try{var o=e(i).find("chdbid");if(0===o.length)throw"This operation requires a parent-level DBID."}catch(r){d(r)}return a(0)})},f.get_schema=function(e){p(!1,"API_GetSchema",f.payload,"db",function(t){return"function"==typeof e?e(t):t})},f.add_record=function(t,n,i){e.isFunction(n)&&(i=n,n=void 0),r(n),e.each(t,function(t,n){return f.payload.append(parseInt(t)==t?e("<field>").attr({fid:t}).append(n):e("<field>").attr({name:t}).append(n))}),p(!1,"API_AddRecord",f.payload,"db",function(e){return"function"==typeof i?i(e):e})},f.delete_record=function(t,n,i){e.isFunction(n)&&(i=n,n=void 0),r(n),f.payload.append("<rid>"+t+"</rid>"),p(!1,"API_DeleteRecord",f.payload,"db",function(e){return"function"==typeof i?i(e):e})},f.do_action=function(t,n,a){i();for(prop in n)opt="<"+prop+">",f.payload.append(e(opt).text(n[prop]));p(!0,t,f.payload,"db",function(e){return"function"==typeof a?a(e):e})},f.do_query=function(t,n,i){n=e.extend({includeRids:1},n);var a,o,d=e("<qid>");isNaN(t)&&(d=e(Boolean(t.match("^[{]"))?"<query>":"<qname>")),f.payload.append(d.text(t));for(a in n){o="<"+a+">";var r=n[a];"string"==typeof r&&(r=r),f.payload.append(e(o).text(r))}p(!0,"API_DoQuery",f.payload,"db",function(e){return"function"==typeof i?i(e):e})},f.edit_record=function(t,n,i,a){var o;e.isFunction(i)&&(a=i,i=void 0),r(i),f.payload.append("<rid>"+t+"</rid>");for(key in n)if(o=n[key],"undefined"!=typeof o){if(parseInt(key)==key){f.payload.append(e("<field>").attr({fid:key}).append(o));continue}f.payload.append(e("<field>").attr({name:key}).append(o))}p(!1,"API_EditRecord",f.payload,"db",function(e){return"function"==typeof a?a(e):e})},f.sign_out=function(t,n){e.isFunction(t)&&(n=t,t=void 0),t&&f.payload.append("<udata>"+t+"</udata>"),p(!1,"API_SignOut",f.payload,"main",function(e){return"function"==typeof n?n(e):e})},this}}(jQuery);