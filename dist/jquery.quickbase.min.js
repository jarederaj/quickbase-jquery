/*
 *  jQuery QuickBase - v1.0.1
 *  A client-size jQuery library for the Intuit QuickBase API.
 *  https://github.com/jarederaj/quickbase-jquery
 *
 *  Made by Jared
 *  Under MIT License
 */
!function(a){a.QuickBase=function(b,c){function d(){k.payload=a("<qdbapi>"),k.payload.append(a("<ticket>").text(k.ticket)),k.payload.append(a("<apptoken>").text(k.settings.apptoken))}function e(b){return a("<div/>").append(b.clone()).html()}function f(a,b,c,d){this.action=a,this.errcode=b,this.errtext=c,this.errdetail=d,alert(c+"\n\n"+d)}function g(a){console.log(a),console.log(a.message)}function h(b){var c,d;if("object"==typeof b)for(c in b)d="<"+c+">",k.payload.append(a(d).text(b[c]))}function i(b,h,i,j,l){j="main"===j?k.base_url+"main":k.base_url+k.settings.dbid,d(),window.loading.show(),a.ajax({type:"POST",beforeSend:function(a){a.setRequestHeader("QUICKBASE-ACTION",h)},url:j,data:e(i),async:k.settings.async,dataType:"xml",contentType:"text/xml",success:function(e){var i,j,k=parseInt(a(e).find("errcode").text(),10);try{if(k>0)throw i=a(e).find("errtext").text(),j=a(e).find("errdetail").text(),new f(h,k,i,j);return d(),"function"==typeof c&&b===!0&&(e=c(e)),"function"==typeof l?l(e):e}catch(m){g(m)}},error:function(a,b,c){console.log(a),console.log(b),console.log(c)}}),k.settings.async=!0}var j={async:!0,username:"",password:"",dbid:"",apptoken:void 0,realm:"www.quickbase.com"},k=this;return k.settings={},k.payload=a("</qbdapi>"),k.init=function(c){return k.settings=a.extend({},j,b),k.base_url="https://"+k.settings.realm+"/db/","undefined"!=typeof k.token||"undefined"!=typeof k.settings.apptoken?"function"==typeof c?c():this:void k.authenticate(void 0,void 0,void 0,function(b){return k.ticket=a(b).find("ticket").text(),"function"==typeof c?c():this})},k.record=function(a,b){var c=isNaN(a)?'name="'+a+'"':'fid="'+a+'"';return"<field "+c+">"+b+"</field>"},k.authenticate=function(b,c,e,f){var g=a("<qdbapi>");return"undefined"==typeof b&&(b=k.settings.username),"undefined"==typeof c&&(c=k.settings.password),"undefined"==typeof e&&(e=""),""===b||""===c?(d(),f(),!1):(g.append(a("<username>").text(b)),g.append(a("<password>").text(c)),g.append(a("<hours>").text(e)),void i(!1,"API_AUTHENTICATE",g,"main",f))},k.build_schema=function(b){var c={};i(!1,"API_GetSchema",k.payload,"db",function(d){function e(d){var g,h,i,j;return k.settings.dbid=a(f[d]).text(),d+1>f.length?"function"==typeof b?b(c):c:void k.get_schema(function(b){function k(b){if(b=b||0,b+1>g.length)return a.extend(c[o],i),!1;var d=a(g[b]),e=d.find("label").text(),f=e.toLowerCase().replace(/\W/g,"_"),h=d.attr("id"),j=d.attr("field_type");i.fields[f]={id:h,label:e,field_type:j},k(b+1)}function l(b){if(b=b||0,b+1>h.length)return a.extend(c[o],j),!1;var d=a(h[b]);query_id=d.attr("id"),query_name_raw=d.find("qyname").text(),query_name=query_name_raw.toLowerCase().replace(/\W/g,"_"),j.queries[query_name]={id:query_id,name:query_name_raw},l(b+1)}var m=a(f[d]),n=m.text(),o=m.attr("name").substring("_dbid_".length);c[o]={dbid:n},g=a(b).find("field"),i={fields:{}},g.length&&k(),h=a(b).find("query"),j={queries:{}},h.length&&l(),e(d+1)})}try{var f=a(d).find("chdbid");if(0===f.length)throw"This operation requires a parent-level DBID."}catch(h){g(h)}return e(0)})},k.get_schema=function(a){i(!1,"API_GetSchema",k.payload,"db",function(b){return"function"==typeof a?a(b):b})},k.add_record=function(b,c,d){a.isFunction(c)&&(d=c,c=void 0),h(c),a.each(b,function(b,c){return k.payload.append(parseInt(b)==b?a("<field>").attr({fid:b}).append(c):a("<field>").attr({name:b}).append(c))}),i(!1,"API_AddRecord",k.payload,"db",function(a){return"function"==typeof d?d(a):a})},k.delete_record=function(b,c,d){a.isFunction(c)&&(d=c,c=void 0),h(c),k.payload.append("<rid>"+b+"</rid>"),i(!1,"API_DeleteRecord",k.payload,"db",function(a){return"function"==typeof d?d(a):a})},k.do_action=function(b,c,e){d();for(var f in c)opt="<"+f+">",k.payload.append(a(opt).text(c[f]));i(!0,b,k.payload,"db",function(a){return"function"==typeof e?e(a):a})},k.do_query=function(b,c,d){c=a.extend({includeRids:1},c);var e,f,g=a("<qid>");isNaN(b)&&(g=a(Boolean(b.match("^[{]"))?"<query>":"<qname>")),k.payload.append(g.text(b));for(e in c){f="<"+e+">";var h=c[e];"string"==typeof h&&(h=h),k.payload.append(a(f).text(h))}i(!0,"API_DoQuery",k.payload,"db",function(a){return"function"==typeof d?d(a):a})},k.edit_record=function(b,c,d,e){var f;a.isFunction(d)&&(e=d,d=void 0),h(d),k.payload.append("<rid>"+b+"</rid>");for(var g in c)if(f=c[g],"undefined"!=typeof f){if(parseInt(g)===g){k.payload.append(a("<field>").attr({fid:g}).append(f));continue}k.payload.append(a("<field>").attr({name:g}).append(f))}i(!1,"API_EditRecord",k.payload,"db",function(a){return"function"==typeof e?e(a):a})},k.sign_out=function(b,c){a.isFunction(b)&&(c=b,b=void 0),b&&k.payload.append("<udata>"+b+"</udata>"),i(!1,"API_SignOut",k.payload,"main",function(a){return"function"==typeof c?c(a):a})},this}}(jQuery);