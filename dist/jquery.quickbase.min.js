/*
 *  jQuery QuickBase - v1.0.0
 *  A client-size jQuery library for the Intuit QuickBase API.
 *  https://github.com/joshuamcginnis/quickbase-jquery
 *
 *  Made by Joshua
 *  Under MIT License
 */
!function(a){a.QuickBase=function(b){function c(){j.payload=a("<qdbapi>"),j.payload.append(a("<ticket>").text(j.ticket)),j.payload.append(a("<apptoken>").text(j.settings.apptoken))}function d(b){return a("<div/>").append(b.clone()).html()}function e(a,b,c,d){this.action=a,this.errcode=b,this.errtext=c,this.errdetail=d}function f(a){console.log(a),console.log(a.message)}function g(b){var c,d;if(b)for(c in b)d="<"+c+">",j.payload.append(a(d).text(b[c]))}function h(b,g,h,i){h="main"===h?j.base_url+"main":j.base_url+j.settings.dbid,a.ajax({type:"POST",beforeSend:function(a){a.setRequestHeader("QUICKBASE-ACTION",b)},url:h,data:d(g),dataType:"xml",contentType:"text/xml",success:function(d){var g,h,j=parseInt(a(d).find("errcode").text(),10);try{if(j>0)throw g=a(d).find("errtext").text(),h=a(d).find("errdetail").text(),new e(b,j,g,h);return c(),"function"==typeof i?i(d):d}catch(k){f(k)}},error:function(a,b,c){console.log(a),console.log(b),console.log(c)}})}var i={username:"",password:"",dbid:"",apptoken:"",realm:"www.quickbase.com"},j=this;return j.settings={},j.payload=a("</qbdapi>"),j.init=function(c){return j.settings=a.extend({},i,b),j.base_url="https://"+j.settings.realm+"/db/","undefined"!=typeof j.token?"function"==typeof c?c():this:(j.authenticate(void 0,void 0,void 0,function(b){return j.ticket=a(b).find("ticket").text(),"function"==typeof c?c():this}),void 0)},j.record=function(a,b){var c=isNaN(a)?'name="'+a+'"':'fid="'+a+'"';return"<field "+c+">"+b+"</field>"},j.authenticate=function(b,c,d,e){var f=a("<qdbapi>");"undefined"==typeof b&&(b=j.settings.username),"undefined"==typeof c&&(c=j.settings.password),"undefined"==typeof d&&(d=""),f.append(a("<username>").text(b)),f.append(a("<password>").text(c)),f.append(a("<hours>").text(d)),h("API_AUTHENTICATE",f,"main",e)},j.build_schema=function(b){var c={};h("API_GetSchema",j.payload,"db",function(d){function e(d){var g,h,i,k;return j.settings.dbid=a(f[d]).text(),d+1>f.length?"function"==typeof b?b(c):c:(j.get_schema(function(b){function j(b){if(b=b||0,b+1>g.length)return a.extend(c[o],i),!1;var d=a(g[b]),e=d.find("label").text(),f=e.toLowerCase().replace(/\W/g,"_"),h=d.attr("id"),k=d.attr("field_type");i.fields[f]={id:h,label:e,field_type:k},j(b+1)}function l(b){if(b=b||0,b+1>h.length)return a.extend(c[o],k),!1;var d=a(h[b]);query_id=d.attr("id"),query_name_raw=d.find("qyname").text(),query_name=query_name_raw.toLowerCase().replace(/\W/g,"_"),k.queries[query_name]={id:query_id,name:query_name_raw},l(b+1)}var m=a(f[d]),n=m.text(),o=m.attr("name").substring("_dbid_".length);c[o]={dbid:n},g=a(b).find("field"),i={fields:{}},g.length&&j(),h=a(b).find("query"),k={queries:{}},h.length&&l(),e(d+1)}),void 0)}try{var f=a(d).find("chdbid");if(0===f.length)throw"This operation requires a parent-level DBID."}catch(g){handleErrors(g)}return e(0)})},j.get_schema=function(a){h("API_GetSchema",j.payload,"db",function(b){return"function"==typeof a?a(b):b})},j.add_record=function(b,c,d){a.isFunction(c)&&(d=c,c=void 0),g(c),a.each(b,function(b,c){j.payload.append(a(c))}),h("API_AddRecord",j.payload,"db",function(a){return"function"==typeof d?d(a):a})},j.delete_record=function(b,c,d){a.isFunction(c)&&(d=c,c=void 0),g(c),j.payload.append("<rid>"+b+"</rid>"),h("API_DeleteRecord",j.payload,"db",function(a){return"function"==typeof d?d(a):a})},j.do_query=function(b,c,d){var e,f,g=a("<qid>");isNaN(b)&&(g=Boolean(b.match("^[{]"))?a("<query>"):a("<qname>")),j.payload.append(g.text(b));for(e in c)f="<"+e+">",j.payload.append(a(f).text(c[e]));h("API_DoQuery",j.payload,"db",function(a){return"function"==typeof d?d(a):a})},j.edit_record=function(b,c,d,e){a.isFunction(d)&&(e=d,d=void 0),g(d),j.payload.append("<rid>"+b+"</rid>"),a.each(c,function(b,c){j.payload.append(a(c))}),h("API_EditRecord",j.payload,"db",function(a){return"function"==typeof e?e(a):a})},j.sign_out=function(b,c){a.isFunction(b)&&(c=b,b=void 0),b&&j.payload.append("<udata>"+b+"</udata>"),h("API_SignOut",j.payload,"main",function(a){return"function"==typeof c?c(a):a})},this}}(jQuery);